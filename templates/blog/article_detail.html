{% extends 'share_layout/base.html' %}
{% load blog_tags %}

{% block header %}
    <title>{{ article.title }} | {{ SITE_DESCRIPTION }}</title>
    <meta property="og:type" content="article"/>
    <meta property="og:title" content="{{ article.title }}"/>


    <meta property="og:description" content="{{ article.body|custom_markdown|striptags|truncatewords:1 }}"/>
    <meta property="og:url"
          content="{{ article.get_full_url }}"/>
    <meta property="article:published_time" content="{% datetimeformat article.pub_time %}"/>
    <meta property="article:modified_time" content="{% datetimeformat article.pub_time %}"/>
    <meta property="article:author" content="{{ article.author.get_full_url }}"/>
    <meta property="article:section" content="{{ article.category.name }}"/>
    {% for t in article.tags.all %}
        <meta property="article:tag" content="{{ t.name }}"/>
    {% endfor %}
    <meta property="og:site_name" content="{{ SITE_NAME }}"/>

    <meta name="description" content="{{ article.body|custom_markdown|striptags|truncatewords:1 }}"/>
    {% if article.tags %}
        <meta name="keywords" content="{{ article.tags.all|join:"," }}"/>
    {% else %}
        <meta name="keywords" content="{{ SITE_KEYWORDS }}"/>
    {% endif %}

{% endblock %}
{% block content %}
    <div id="primary" class="site-content">
        <div id="content" role="main">
            {% load_article_detail article False user %}

            {% if user.is_authenticated %}
                <div class="favorite-container" style="margin: 20px 0;">
                    <button id="favoriteBtn" class="btn btn-primary" data-article-id="{{ article.id }}">
                        <i class="fa fa-star"></i> 
                        <span id="favoriteText">收藏文章</span>
                    </button>
                </div>
            {% endif %}

            {% if article.type == 'a' %}
                <nav class="nav-single">
                    <h3 class="assistive-text">文章导航</h3>
                    {% if next_article %}

                        <span class="nav-previous"><a href="{{ next_article.get_absolute_url }}" rel="prev"><span
                                class="meta-nav">&larr;</span> {{ next_article.title }}</a></span>
                    {% endif %}
                    {% if prev_article %}
                        <span class="nav-next"><a href="{{ prev_article.get_absolute_url }}"
                                                  rel="next">{{ prev_article.title }} <span
                                class="meta-nav">&rarr;</span></a></span>
                    {% endif %}
                </nav><!-- .nav-single -->
            {% endif %}

        </div><!-- #content -->
        {% if article.comment_status == "o" and OPEN_SITE_COMMENT %}


            {% include 'comments/tags/comment_list.html' %}
            {% if user.is_authenticated %}
                {% include 'comments/tags/post_comment.html' %}
            {% else %}
                <div class="comments-area">
                    <h3 class="comment-meta">您还没有登录，请您<a
                            href="{% url "account:login" %}?next={{ request.get_full_path }}" rel="nofollow">登录</a>后发表评论。
                    </h3>

                    {% load oauth_tags %}
                    {% load_oauth_applications request %}

                </div>
            {% endif %}
        {% endif %}
    </div><!-- #primary -->

    {% if user.is_authenticated %}
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const favoriteBtn = document.getElementById('favoriteBtn');
            const favoriteText = document.getElementById('favoriteText');
            const articleId = favoriteBtn.dataset.articleId;

            // 检查是否已收藏
            fetch(`/favorite/check/${articleId}/`)
                .then(response => response.json())
                .then(data => {
                    if (data.is_favorite) {
                        favoriteBtn.classList.remove('btn-primary');
                        favoriteBtn.classList.add('btn-danger');
                        favoriteText.textContent = '取消收藏';
                    }
                });

            favoriteBtn.addEventListener('click', function() {
                const isFavorite = favoriteBtn.classList.contains('btn-danger');
                const url = isFavorite ? `/favorite/remove/${articleId}/` : `/favorite/add/${articleId}/`;

                fetch(url, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': getCookie('csrftoken')
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        if (isFavorite) {
                            favoriteBtn.classList.remove('btn-danger');
                            favoriteBtn.classList.add('btn-primary');
                            favoriteText.textContent = '收藏文章';
                        } else {
                            favoriteBtn.classList.remove('btn-primary');
                            favoriteBtn.classList.add('btn-danger');
                            favoriteText.textContent = '取消收藏';
                        }
                    }
                });
            });

            // 获取CSRF Token的函数
            function getCookie(name) {
                let cookieValue = null;
                if (document.cookie && document.cookie !== '') {
                    const cookies = document.cookie.split(';');
                    for (let i = 0; i < cookies.length; i++) {
                        const cookie = cookies[i].trim();
                        if (cookie.substring(0, name.length + 1) === (name + '=')) {
                            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                            break;
                        }
                    }
                }
                return cookieValue;
            }
        });
    </script>
    {% endif %}
{% endblock %}

{% block sidebar %}
    {% load_sidebar user "p" %}
{% endblock %}